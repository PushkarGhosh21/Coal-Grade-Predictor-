{% extends "base.html" %}

{% block content %}
<div class="container pt-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            
            <div class="d-flex align-items-center justify-content-between mb-4 pb-2 border-bottom" style="border-color: #000080 !important;">
                <h2 class="fw-bold m-0 text-gov font-header">
                    <i class="fas fa-calculator me-2"></i> Prediction Dashboard
                </h2>
                <span class="badge bg-primary">Live System</span>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow border-0 mb-4 h-100">
                        <div class="card-header text-white p-3" style="background-color: #000080;">
                            <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i> Parameters</h5>
                        </div>
                        <div class="card-body p-4 bg-light">
                            <form id="predictForm">
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-gov">Subsidiary (Sub Code)</label>
                                    <select class="form-select border-primary" id="subCode" required>
                                        <option value="" disabled selected>-- Select --</option>
                                        <option value="WCL">WCL</option>
                                        <option value="NCL">NCL</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-gov">Mining Area</label>
                                    <select class="form-select border-primary" id="area" disabled required>
                                        <option value="" disabled selected>Select Subsidiary First</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-gov">Declared Grade (Ref)</label>
                                    <select class="form-select bg-white" id="declaredGrade" disabled>
                                        <option value="">-- Auto Populated --</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-gov">Quantity (Tonnes)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control border-primary" id="quantity" placeholder="e.g. 500" min="1" step="0.1" required>
                                        <span class="input-group-text bg-primary text-white">MT</span>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label class="form-label fw-bold text-gov">Month</label>
                                        <select class="form-select border-primary" id="month" required>
                                            <option value="" disabled selected>Select</option>
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold text-gov">Year</label>
                                        <select class="form-select border-primary" id="year" required>
                                            </select>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 btn-lg mt-2 fw-bold shadow-sm" style="background-color: #0E3386;">
                                    PREDICT COST & GRADE
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow border-0 h-100">
                        <div class="card-header text-white p-3" style="background-color: #191970;">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> AI Analysis Results</h5>
                        </div>
                        <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center" id="resultContainer">
                            
                            <div id="loader" class="text-center" style="display: none;">
                                <div class="spinner-border" style="width: 3rem; height: 3rem; color: #0000CD;" role="status"></div>
                                <p class="mt-3 fw-bold text-muted">Calculating Valuation...</p>
                            </div>

                            <div id="placeholder" class="text-center text-muted opacity-50">
                                <i class="fas fa-arrow-left fa-3x mb-3"></i>
                                <h4>Enter Quantity & Area to generate report</h4>
                            </div>

                            <div id="result-box" class="w-100" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="alert text-center shadow-sm h-100 d-flex flex-column justify-content-center" style="background-color: #E8EAF6; border-left: 8px solid #191970;">
                                            <h6 class="text-uppercase fw-bold mb-2" style="color: #000080;">Predicted Grade</h6>
                                            <h1 class="display-3 fw-bold mb-0" style="color: #0E3386;" id="resGrade">--</h1>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <div class="alert text-center shadow-sm h-100 d-flex flex-column justify-content-center" style="background-color: #FFF3E0; border-left: 8px solid #FF9800;">
                                            <h6 class="text-uppercase fw-bold mb-2" style="color: #E65100;">Total Est. Cost</h6>
                                            <h2 class="fw-bold mb-0" style="color: #E65100;">₹ <span id="resCost">--</span></h2>
                                            <small class="text-muted">@ ₹<span id="resPrice">--</span> / Tonne</small>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-secondary mb-3 ps-1">Proximate Analysis & GCV</h6>
                                <div class="row g-3">
                                    <div class="col-md-3 col-6">
                                        <div class="p-3 border rounded bg-light text-center h-100">
                                            <small class="text-uppercase text-muted fw-bold d-block mb-1">GCV</small>
                                            <h4 class="fw-bold text-dark mb-0" id="resGCV">--</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="p-3 border rounded bg-light text-center h-100">
                                            <small class="text-uppercase text-muted fw-bold d-block mb-1">Ash</small>
                                            <h4 class="fw-bold text-dark mb-0" id="resAsh">--%</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="p-3 border rounded bg-light text-center h-100">
                                            <small class="text-uppercase text-muted fw-bold d-block mb-1">Moisture</small>
                                            <h4 class="fw-bold text-dark mb-0" id="resM">--%</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="p-3 border rounded bg-light text-center h-100">
                                            <small class="text-uppercase text-muted fw-bold d-block mb-1">Total M</small>
                                            <h4 class="fw-bold text-dark mb-0" id="resTM">--%</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const wclList = {{ wcl_areas | tojson }};
    const nclList = {{ ncl_areas | tojson }};
    const gradeMap = {{ area_grades | tojson }};

    const subCodeSelect = document.getElementById('subCode');
    const areaSelect = document.getElementById('area');
    const declaredGradeSelect = document.getElementById('declaredGrade');
    const yearSelect = document.getElementById('year');
    
    // 0. Populate Years (Current Year - 10 to Current Year + 2)
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 10; i <= currentYear + 2; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        if(i === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
    }
    // Set default month to current month
    document.getElementById('month').value = new Date().getMonth() + 1;

    // 1. Logic: SubCode -> Area
    subCodeSelect.addEventListener('change', function() {
        const selectedCode = this.value;
        let options = [];

        areaSelect.innerHTML = '<option value="" disabled selected>Choose Area...</option>';
        declaredGradeSelect.innerHTML = '<option value="">-- Auto Populated --</option>';
        
        areaSelect.disabled = false;

        if (selectedCode === 'WCL') options = wclList;
        else if (selectedCode === 'NCL') options = nclList;

        options.forEach(area => {
            const opt = document.createElement('option');
            opt.value = area;
            opt.textContent = area;
            areaSelect.appendChild(opt);
        });
    });

    // 2. Logic: Area -> Declared Grade
    areaSelect.addEventListener('change', function() {
        const area = this.value;
        
        declaredGradeSelect.innerHTML = '';
        const grades = gradeMap[area] || [];
        if(grades.length === 0) {
            declaredGradeSelect.innerHTML = '<option>N/A</option>';
        } else {
            grades.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                declaredGradeSelect.appendChild(opt);
            });
        }
    });

    // 3. Prediction Logic
    document.getElementById('predictForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const subCode = subCodeSelect.value;
        const area = areaSelect.value;
        const quantity = document.getElementById('quantity').value;
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        
        const resultBox = document.getElementById('result-box');
        const placeholder = document.getElementById('placeholder');
        const loader = document.getElementById('loader');

        placeholder.style.display = 'none';
        resultBox.style.display = 'none';
        loader.style.display = 'block';

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    sub_code: subCode,
                    area: area, 
                    quantity: quantity,
                    month: month,
                    year: year
                })
            });
            const data = await response.json();
            
            loader.style.display = 'none';

            if (data.success) {
                resultBox.style.display = 'block';
                
                document.getElementById('resGrade').innerText = data.final_grade;
                document.getElementById('resCost').innerText = data.total_estimated_cost;
                document.getElementById('resPrice').innerText = data.price_per_tonne;
                
                document.getElementById('resGCV').innerText = data.details.gcv;
                document.getElementById('resAsh').innerText = data.details.ash + '%';
                document.getElementById('resM').innerText = data.details.moisture + '%';
                document.getElementById('resTM').innerText = data.details.total_moisture + '%';
            } else {
                alert("Error: " + data.error);
                placeholder.style.display = 'block';
            }
        } catch (error) {
            loader.style.display = 'none';
            alert("Connection Failed");
            placeholder.style.display = 'block';
        }
    });
</script>
{% endblock %}